# Fan-in pattern

← [К списку паттернов](README.md)

## Коротко для собеседования

**Fan-in** — это паттерн конкурентности,
при котором данные из нескольких каналов
собираются в один выходной канал.

Fan-in не выполняет обработку данных,
а только объединяет потоки.

---

## Когда использовать

- есть несколько источников данных
- каждый источник пишет в свой канал
- нужно собрать всё в один поток
- этап агрегации в pipeline

---

## Когда НЕ использовать

- один источник данных
- воркеры уже пишут в общий канал
- достаточно обычного worker pool

---

## Схема

1. Есть несколько входных каналов (`ch1`, `ch2`, `ch3`)
2. Fan-in читает данные из каждого канала
3. Все значения передаются в один выходной канал (`out`)
4. `out` закрывается, когда все входные каналы завершены

---

## пример c selectom

```go
out := make(chan int)
    wg := sync.WaitGroup

    go func() {
          for _, ch := range chans {
              wg.Add(1)
              go func(){
                  defer wg.Done()
                  for {
                      select {
                           case v, ok := <- ch:
                               if !ok {
                                   return
                               }
                               select {
                                   case <-ctx.Done():
                                   return
                                   case out <- v:  
                               }
                           case <-ctx.Done():
                           return
                      }
                  }
              }()
          }
        wg.Wait()
        close(out)
    }()    
    return out
}
```
# Ключевые правила

- fan-in не выполняет бизнес-логику

- fan-in читает из нескольких каналов

- выходной канал должен закрываться один раз

- закрытие out происходит после завершения всех источников

#Типичные ошибки

- fan-in выполняет вычисления

- out закрывается слишком рано

- утечка goroutine при незавершённых источниках

# Связь с другими паттернами

- Fan-in — стадия агрегации

- Fan-out — стадия распределения

- Pipeline — часто содержит fan-in

- Worker Pool — fan-in может быть неявным


