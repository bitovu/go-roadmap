# Map под капотом

---

## Краткий ответ на собеседовании

`map` в Go — это хеш-таблица.  
Внутри она состоит из массива бакетов, использует хеширование ключей
для быстрого доступа и автоматически растёт с помощью механизма эвакуации.
`map` не является потокобезопасной.

---

## Общая структура `map`

На уровне реализации `map` включает:

- массив бакетов
- хеш-функцию
- счётчик элементов
- структуру для управления ростом

Данные в `map` **не хранятся последовательно** —
они распределяются по бакетам на основе хеша ключа.

---

## Бакеты (buckets)

Каждый бакет содержит:

- до **8 ключей**
- соответствующие значения
- массив `tophash` (части хеша ключей)
- указатель на overflow-бакет (если бакет переполнен)

Если в одном бакете больше 8 элементов,
создаётся **overflow-бакет**.

---

## Хеширование ключей

При добавлении или поиске элемента:

1. ключ хешируется
2. часть хеша определяет индекс бакета
3. `tophash` используется для быстрого сравнения
4. при совпадении выполняется сравнение ключей

```go
m := make(map[string]int)
m["go"] = 1
```
-Хеш-функция зависит от типа ключа и может быть разной для разных типов.

## Эвакуация (рост map)
Когда `map` растёт:

* создаётся новый массив бакетов

* старые элементы не копируются сразу

* перенос происходит постепенно при доступе к данным

Этот процесс называется эвакуацией.

Преимущества:

* нет долгих пауз
* равномерное распределение нагрузки
* рост происходит прозрачно для пользователя

## Алгоритмическая сложность
Средняя сложность операций:
* чтение: O(1)
* запись: O(1)
* удаление: O(1)
* В худшем случае (много коллизий): O(n)

На практике коллизии минимизируются
качественным хешированием.

## Потокобезопасность
❌ map не потокобезопасна
одновременная запись → `panic`
чтение + запись → `panic`
```
```go
fatal error: concurrent map writes
```

Как работать с` map` в конкурентной среде
Используют:

- sync.Mutex
- sync.RWMutex
- sync.Map (для специфических сценариев)

```go
var mu sync.Mutex

mu.Lock()
m[key] = value
mu.Unlock()
```

Короткая формула для запоминания
* map = хеш-таблица
* данные лежат в бакетах
* рост через эвакуацию
* средняя сложность O(1)
* не потокобезопасна

---

<div align="center">

⬅️ **[домой,уолтер](../)**

</div>
