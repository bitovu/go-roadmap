# Go: Context

## Что такое Context
**Context** — механизм управления жизненным циклом операций.

Используется для:
- отмены выполнения
- таймаутов и дедлайнов
- передачи request-scoped данных
- корректного завершения горутин

Context передаётся **явно** между функциями.

---

## Зачем нужен Context
Решает проблемы:
- утечки горутин
- бесконционного ожидания
- неконтролируемых фоновых операций
- каскадной отмены запросов

Главная идея:
> если запрос завершён — всё связанное с ним должно остановиться

---

## Background
**Назначение:** корневой контекст приложения

Используется:
- в `main`
- при инициализации
- для долгоживущих процессов

Особенности:
- никогда не отменяется
- не имеет дедлайна
- обычно стартовая точка для всех контекстов

---

## TODO
**Назначение:** временная заглушка

Используется:
- когда ещё не ясно, какой контекст нужен
- в тестах
- во временном коде

Особенности:
- функционально как Background
- сигнал разработчику: «переделать»

---

## withCancel
**Назначение:** ручная отмена контекста

Используется:
- при управлении жизненным циклом
- для остановки горутин
- при раннем выходе из логики

Особенности:
- отмена распространяется вниз по дереву
- отмена должна вызываться всегда
- частая причина утечек — забытый cancel

---

## withTimeout
**Назначение:** автоматическая отмена по таймауту

Используется:
- сетевые запросы
- I/O операции
- внешние сервисы

Особенности:
- таймаут отсчитывается от создания
- отмена происходит автоматически
- всегда нужно освобождать ресурсы

---

## withDeadline
**Назначение:** отмена к конкретному моменту времени

Используется:
- при работе с SLA
- при синхронизации по времени
- когда дедлайн известен заранее

Особенности:
- более точный контроль, чем timeout
- по сути timeout с фиксированным временем

---

## withValue
**Назначение:** context.WithValue(ctx, key, val) — добавляет данные в контекст (для метаданных, не бизнес-логики!).

Используется:
- request-id
- user-id
- trace-id

НЕ используется:
- для бизнес-логики
- для передачи больших структур
- как замена параметров функций

Особенности:
- данные только для чтения
- ключи должны быть уникальными типами

---

## ctx.Done
**Назначение:** сигнал отмены

Используется:
- для остановки работы
- для выхода из ожиданий
- для корректного завершения горутин

Особенности:
- закрывается при отмене
- должен проверяться регулярно
- основной механизм реакции на cancel

---

## Дерево контекстов
- Context образует иерархию
- отмена родителя отменяет всех потомков
- дедлайн родителя важнее дедлайна ребёнка

---

## Типичные ошибки
- не передавать context дальше
- использовать Background внутри запроса
- класть бизнес-данные в withValue
- не реагировать на ctx.Done
- забывать вызывать cancel

---

## Когда Context обязателен
- HTTP-серверы
- gRPC
- фоновые задачи
- любые долгие операции

---

## Коротко
- Context управляет временем жизни
- отмена — ключевая идея
- передаётся первым аргументом
- не хранится в структурах

---

## Золотое правило
> Context — это сигнал «хватит работать»
